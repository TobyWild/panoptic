<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <!-- This is a wide open CSP declaration. To lock this down for production, see below. -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *" />
    <!-- Good default declaration:
    * gap: is required only on iOS (when using UIWebView) and is needed for JS->native communication
    * https://ssl.gstatic.com is required only on Android and is needed for TalkBack to function properly
    * Disables use of eval() and inline scripts in order to mitigate risk of XSS vulnerabilities. To change this:
        * Enable inline JS: add 'unsafe-inline' to default-src
        * Enable eval(): add 'unsafe-eval' to default-src
    * Create your own at http://cspisawesome.com
    -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: 'unsafe-inline' https://ssl.gstatic.com; style-src 'self' 'unsafe-inline'; media-src *" /> -->
    
    <link rel="stylesheet" type="text/css" href="css/custom.css" />
    <title>Panoptic</title>
</head>

<body>

  <div id="loadingDiv">Loading, please wait</div>

  <div class="app">
  
    <div class="controls">
      <select id="nid"></select>
      <button onclick="requestPage();">Request Site Details<span class="icon-send"></span></button>
    </div>
    
    <div id="pageContent"></div>
    
    <div class="break-border"></div>
    
    <div class="card">
      <h2 class="title">At a glance</h2>
      <div id="glance"></div>
    </div>
    
    <div class="card">
      <h2 class="title">Contact OPC</h2>
      <a class="half-button" href="tel:1300788616"><span class="icon-phone"></span>Call</a>
      <a class="half-button" href="mailto:Service.Desk@opc.com.au"><span class="icon-mail_outline"></span>Email</a>
    </div>
    
    <div class="action">
      <a class="left" href="index.html"><span class="icon-refresh"></span>Refresh</a>
      <a class="right" href="login.html"><span class="icon-lock_open"></span>Logout</a>
    </div>
    
  </div>
  
  <script type="text/javascript" src="cordova.js"></script>
  <script type="text/javascript" src="js/index.js"></script>
  <script type="text/javascript" src="js/ping.js"></script>
  <script type="text/javascript" src="js/jquery.min.js"></script>
  <script type="text/javascript">
  
    app.initialize();
    
    if(!localStorage.atoken){
      window.location = "login.html";
    }
    
    $('#loadingDiv')
      .hide()
      .ajaxStart(function() {
        $(this).show();
      })
      .ajaxStop(function() {
        $(this).hide();
      });
    
    function getSiteList(){
      $.ajax({
        url: 'http://panopticmonitor.com/api/views/users_nodes?args='+localStorage.userID,
        method: 'GET',
        crossDomain: true,
        cache: true,
        jsonp: true,
        beforeSend: function (xhr) {
          xhr.setRequestHeader ("Authorization", "Bearer " + localStorage.atoken);
        },
        success: function (returnData) {
          viewsData = $.parseJSON(returnData);
          var selectList = document.getElementById("nid");
          glanceList = '';
          for (i in viewsData) {
            tempVal = viewsData[i].site;
            tempVal = tempVal.split(':');
            var option = document.createElement("option");
            option.value = tempVal[0];
            option.text = tempVal[1];
            selectList.add(option);

            bigString = viewsData[i].decode;

            if( bigString.length > 5 ){
              glanceList += '<div class="glance-item hasupdates status-'+viewsData[i].updown+'">'+tempVal[1]+'<span>'+viewsData[i].updown+'</span></div>';
            } else {
              glanceList += '<div class="glance-item noupdates status-'+viewsData[i].updown+'">'+tempVal[1]+'<span>'+viewsData[i].updown+'</span></div>';
            }
          }
          $('#glance').html(glanceList);
        },
        error: function(){
          $('#pageContent').html('Failed to find users sites from View, try again.');
        }
      });
    };
    
    getSiteList();
    
    function requestPage(){
      nid = $('#nid').attr('value');
      $.ajax({
        url: 'http://panopticmonitor.com/api/node/'+nid,
        method: 'GET',
        crossDomain: true,
        cache: true,
        jsonp: true,
        beforeSend: function (xhr) {
          xhr.setRequestHeader ("Authorization", "Bearer " + localStorage.atoken);
        },
        success: function (returnData) {
        
          rtData = $.parseJSON(returnData);
          
          htmlString = '';
          htmlString += '<div class="card">';
            htmlString += '<h2 class="title">Overview</h2>';
            htmlString += '<h3>'+rtData.title+'</h3>';
            htmlString += '<h3><a href="'+rtData.field_app_url.und[0].value+'">'+rtData.field_app_url.und[0].value+'</a></h3>'
          htmlString += '</div>';
          
          modules = jQuery.parseJSON(rtData.field_app_module_decode.und[0].value);
          
          if( modules  != null && modules.length > 5 ){
          
            htmlString += '<div class="card">';
              htmlString += '<h2 class="title">Available module updates</h2>';
              htmlString += '<table class="module-table">';
                htmlString += '<thead>';
                  htmlString += '<tr>';
                    htmlString += '<th>Title</th>';
                    htmlString += '<th>Existing Ver.</th>';
                    htmlString += '<th>Latest Ver.</th>';
                  htmlString += '</tr>';
                htmlString += '</thead>';
                htmlString += '<tbody>';
                  
                  for (i in modules) {
                    htmlString += '<tr>';
                      htmlString += '<td class="cap">' + modules[i].name + '</td>';
                      htmlString += '<td class="cap">' + modules[i].existing_version + '</td>';
                      htmlString += '<td class="cap">' + modules[i].latest_version + '</td>';
                    htmlString += '</tr>';
                  }
                  
                htmlString += '</tbody>';
              htmlString += '</table>';
            htmlString += '</div>';
            
          }
          
          htmlString += '<div class="card">';
            htmlString += '<h2 class="title">Response Time</h2>';
            htmlString += '<h3><span class="icon-timer"></span><span id="ping-response"></span> ms</h3>';
          htmlString += '</div>';
          htmlString += '';
          
          $('#pageContent').html(htmlString);
          
          var p = new Ping();
          p.ping(rtData.field_app_url.und[0].value, function(data) {
            document.getElementById("ping-response").innerHTML = data;
          });
        },
        error: function(){
          $('#pageContent').html('Failed to connect, try again.');
        }
      });
    }
  </script>
</body>

</html>